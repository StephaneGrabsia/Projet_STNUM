---
title: "parser"
output: html_document
date: "2022-11-25"
---

```{r}
library(GGally)
library(ggplot2)
library(FactoMineR)
library(cluster)
library(factoextra)
library(heatmaply)
library(dplyr)
library(tidyr)
library(ade4)
library(scales)
library(reshape2)
```

```{r}
data <-read.csv("data_project.csv", sep=";")
print(data)
set.seed(10)
```

# Statistiques descriptives

##Analyse générale

Matrice de corrélation
```{r}
cleaned_data = data[ (data$vitamin.c_100g<100) & (data$energy.kcal_100g<1000) & (data$proteins_100g<100) & (data$sugars_100g < 80) & (data$fat_100g < 100) & (data$saturated.fat_100g < 100) & (data$fiber_100g <100) & (data$salt_100g < 100) & (data$sodium_100g <20) & (data$vitamin.a_100g < 0.12) & (data$calcium_100g < 10), ]

#ggpairs(data[c(3:13)])

gradient_col <- ggplot2::scale_fill_gradient2(
   low = "blue", high = "red", 
    midpoint = 0.5, limits = c(0, 1)
  )

heatmaply_cor(
  cor(cleaned_data[c(3:14)]),
  scale_fill_gradient=gradient_col,
  cellnote=round(cor(cleaned_data[c(3:14)]),2),
  cellnote_color = "auto",
  cellnote_textposition = "middle center",
  cellnote_size = 6,
  show_dendrogram=c(FALSE,FALSE),
)
```


Variances 
```{r}
sapply(data[c(3:13)], var)
```

## Analyse des différentes variables

### Vitamine A
```{r}
vitamine_a <- data$vitamin.a_100g
max_vit_a <- max(vitamine_a)
hist(vitamine_a,freq=TRUE,xlab="nutriscore",main="Histogramme vitamine A",breaks=100)
boxplot(vitamine_a,main="Boite à moustaches vitamine A")
```
```{r}
vitamine_a <- data[data$vitamin.a_100g<100,]$vitamin.a_100g
without_vit_a <- data[data$vitamin.a_100g==0,]$vitamin.a_100g
max_vit_a <- max(vitamine_a)
hist(vitamine_a,freq=TRUE,xlab="nutriscore",main="Histogramme vitamine A",breaks=100)
boxplot(vitamine_a,main="Boite à moustaches vitamine A")
```

### Nutriscore
```{r}
nutriscore_score <- data$nutriscore_score
hist(nutriscore_score,freq=TRUE,xlab="nutriscore",main="Histogramme nustriscore",breaks=100)
boxplot(nutriscore_score,main="Boite à moustaches nutriscore")
```

Analyse des différentes variables

### Vitamine C
Vitamines C sans filtre :

```{r}
vitamine_c <- data$vitamin.c_100g
max_vit_c <- max(vitamine_c)
hist(vitamine_c,freq=TRUE,xlab="nutriscore",main="Histogramme vitamine C",breaks=100)
boxplot(vitamine_c,main="Boite à moustaches vitamine C")
```

Vitamines C avec filtre :

```{r}
vitamine_c <- data[data$vitamin.c_100g<100,]$vitamin.c_100g
without_vit_c <- data[data$vitamin.c_100g==0,]$vitamin.c_100g
max_vit_c <- max(vitamine_c)
hist(vitamine_c,freq=TRUE,xlab="nutriscore",main="Histogramme vitamine C",breaks=100)
boxplot(vitamine_c,main="Boite à moustaches vitamine C")
```

### Sodium 
```{r}
sodium_100g <- data$sodium_100g
hist(sodium_100g,freq=TRUE,xlab="Sodium for 100g", main="Histogramme")
boxplot(data[,c("sodium_100g")],main="Boites à moustaches")

```

### Sel
```{r}
salt_100g <- data$salt_100g
hist(salt_100g,freq=TRUE,xlab="Salt for 100g",main="Histogramme")
boxplot(salt_100g,main="Boites à moustaches")
```

Nous remarquons que deux valeurs semblent incohérentes. En effet la boîte à moustache nous montre que deux valeurs ont un taux de sel supérieur à 100/100g. 

```{r}
values_salt <- data[data$salt_100g>100,]$product_name
print(values_salt)
```
Nous allons donc retirer de notre base de données ces deux valeurs : Marie sharps orange pulp habanero hot sauce et Steak seasoning. 

```{r}
salt <- data[data$salt_100g<100,]$salt_100g
boxplot(salt,main="Boites à moustaches")

hist(salt,freq=TRUE,xlab="Salt for 100g",main="Histogramme", breaks=100)

```
```{r}
sodium <- data[data$sodium_100g<100,]$sodium_100g
boxplot(sodium,main="Boites à moustaches")

hist(sodium,freq=TRUE,xlab="Sodium for 100g",main="Histogramme", breaks=100)
```

Près de 3000 produits ne contiennent pas du tout de sel. 

### Energy, Proteine et Sucre

```{r}
## Including Plots
hist(as.double(data_of_interest$energy.kcal_100g),freq=TRUE,xlab="Energy in kcal for 100g",main="Histogramme", breaks = 100)
hist(as.double(data_of_interest$proteins_100g),freq=TRUE,xlab="Proteins for 100g",main="Histogramme", breaks = 100)
hist(as.double(data_of_interest$sugars_100g),freq=TRUE,xlab="Sugars for 100g",main="Histogramme", breaks = 100)

plot(ecdf(data_of_interest$energy.kcal_100g),main="Energy")
plot(ecdf(data_of_interest$proteins_100g),main="Proteins")
plot(ecdf(data_of_interest$sugars_100g),main="Sugar")

boxplot(data_of_interest[,c("energy.kcal_100g")],main="Boites à moustache énergie")
boxplot(data_of_interest[,c("proteins_100g","sugars_100g")],main="Boites à moustaches des deux variables")

mytable <- table(data$nutriscore_grade)
options(digits=4)
percentage <- round(100*mytable/sum(mytable),digits = 2)

lbls <- paste(names(mytable), "\n", percentage, "%", sep="")
pie(mytable, labels = lbls,
   main="Nutriscore grade repartition")
```

Analyse Energie:
```{r}
strange_products_energy = data[data_of_interest$energy.kcal_100g>1000,]
strange_products_name_energy <- strange_products_energy$product_name
print(strange_products_energy)
clean_data_energy = data[data_of_interest$energy.kcal_100g<1000,]
hist(as.double(clean_data_energy$energy.kcal_100g),freq=TRUE,xlab="Energy in kcal for 100g",main="Histogramme", breaks = 100)
```
Il n'y a pas d'aliments bizarres concernant la proteine.

Analyse Proteins:
```{r}
hist(as.double(data_of_interest$proteins_100g),freq=TRUE,xlab="Proteins for 100g",main="Histogramme", breaks = 100)
strange_products_proteins = data[data_of_interest$proteins_100g>80,]
strange_products_name_proteins <- strange_products_proteins$product_name
print(strange_products_proteins)
clean_data_proteins = data[data_of_interest$proteins_100g<80,]
hist(as.double(clean_data_proteins$proteins_100g),freq=TRUE,xlab="Proteins for 100g",main="Histogramme", breaks = 100)
```
Analyse Sucre:
```{r}
hist(as.double(data_of_interest$sugars_100g),freq=TRUE,xlab="Sugars for 100g",main="Histogramme", breaks = 100)
strange_products_sugars = data[data_of_interest$sugars_100g>80,]
strange_products_name_sugars <- strange_products_sugars$product_name
print(strange_products_sugars)
clean_data_sugars = data[data_of_interest$sugars_100g<80,]
hist(as.double(clean_data_proteins$sugars_100g),freq=TRUE,xlab="Sugars for 100g",main="Histogramme", breaks = 100)
```

"
### Calcium 
Calcium sans filtre :
```{r}
calcium <- data$calcium_100g
max_calcium <- max(calcium)
hist(calcium,freq=TRUE,xlab="calcium",main="Histogramme calcium",breaks=100,xlim = c(0,max_calcium))
boxplot(calcium,main="Boite à moustaches calcium")
```

Calcium avec filtre :

```{r}
calcium <- data[data$calcium_100g<10,]$calcium_100g
max_calcium <- max(calcium)
hist(calcium,freq=TRUE,xlab="calcium",main="Histogramme calcium",breaks=100,xlim = c(0,max_calcium))
boxplot(calcium,main="Boite à moustaches calcium")
```

### Analyse Louise
```{r}
hist(as.numeric(data$fat_100g),
     freq=FALSE,
     breaks=50,
     xlab="fat",
     main="Histogramme")

boxplot(as.numeric(data$fat_100g),main="Boite à moustaches fat")

fat<-data[data$fat_100g>0,]$fat_100g
hist(as.numeric(fat) ,
     freq=FALSE,
     breaks=50,
     xlab="fat (with no 0)",
     main="Histogramme")
```

```{r}
hist(as.numeric(data$saturated.fat_100g) ,
     freq=FALSE,
     breaks=50,
     xlab="saturated fat",
     main="Histogramme")

boxplot(as.numeric(data$saturated.fat_100g),main="Boite à moustaches saturated fat")

saturated.fat<-data[data$saturated.fat_100g>0,]$saturated.fat_100g
hist(as.numeric(saturated.fat) ,
     freq=FALSE,
     breaks=50,
     xlab="saturated fat (with no 0)",
     main="Histogramme")
```


```{r}
hist(as.numeric(data$fiber_100g) ,
     freq=FALSE,
     breaks=50,
     xlab="fiber",
     main="Histogramme")

boxplot(as.numeric(data$fiber_100g),main="Boite à moustaches fiber")

fiber<-data[data$fiber_100g>0,]$fiber_100g
hist(as.numeric(fiber) ,
     freq=FALSE,
     breaks=50,
     xlab="fiber (with no 0)",
     main="Histogramme")
```

```{r}
strange_products_fiber = data[data$fiber_100g>90,]
strange_products_name_fiber <- strange_products_fiber$product_name
print(strange_products_fiber)
```

#ACP
ACP
```{r}
out_acp <- PCA(cleaned_data[,c(3:10, 12:14)],scale.unit=TRUE,ncp=11,graph=FALSE)
summary(out_acp)
```

Valeurs propres
```{r}
val_prop <- out_acp$eig[,"eigenvalue"]
cp <- 1:length(val_prop)
vp <- data.frame(cp=cp,val_prop=val_prop)

ggplot(data=vp,aes(x=cp,y=val_prop, fill=val_prop))+
  geom_bar(stat="identity", width = 0.7)+
  ggtitle("Eboulis des valeurs propres")+
  xlab("Nombre de composantes principales")+
  ylab("Valeurs propres")+
  scale_x_continuous(breaks=cp)

```
3 composantes principales : 1, 2 et 3

Inertie
```{r}
fviz_eig(out_acp, addlabels = TRUE, ylim = c(0, 50), barfill = "navyblue",
  barcolor = "navyblue" ,linecolor = "black" , hjust=0)

```

Cercle de corrélation
```{r}
plot.PCA(out_acp,shadow=TRUE,cex=0.8,axes=c(1,2),choix="var",new.plot=TRUE,
         title="Cercle des corrélations", gradient.cols = c("blue", "red"),)

```
```{r}
fviz_pca_var(out_acp, axes = c(1,2),
             col.var = "cos2",
             gradient.cols = c("navyblue","blue"),
             repel = TRUE)
```
```{r}
fviz_pca_var(out_acp, axes = c(2,3),
             col.var = "cos2",
             gradient.cols = c("navyblue","blue"),
             repel = TRUE)
```
```{r}
fviz_pca_var(out_acp, axes = c(1,3),
             col.var = "cos2",
             gradient.cols = c("navyblue","blue"),
             repel = TRUE)
```


Qualité et représentation des ingrédients (à faire)

library("corrplot")
corrplot(data$contrib(c[3:14]), is.corr=FALSE)

Projection de l'ACP
```{r}
plot.PCA(out_acp,shadow=TRUE,cex=2,axes=c(1,2),choix="ind",label="none",new.plot=TRUE, title="Projection des individus")
```
Data réduites pour tourner
```{r}
vec <- sample(x = 1:nrow(cleaned_data), size = 2000)
data_for_cluster <- cleaned_data[c(vec),c(3:10,12:14)]
data_for_cluster_grade <- cleaned_data[c(vec),c(3:10,12:15)]
```

CAH
```{r}
fviz_nbclust(data_for_cluster, FUNcluster = hcut, method = "silhouette",hc_method = "average", hc_metric = "euclidean", stand = TRUE)
library(NbClust)
NbClust(data_for_cluster, distance = "euclidean", method = "average")
```

Dendogramme
```{r}
cah_ward <- agnes(data_for_cluster,metric="euclidean",stand=TRUE,method="ward")
plot(as.dendrogram(cah_ward),main="Ward")

ei <- data.frame(k=2:dim(data_for_cluster)[1],height=sort(cah_ward$height,decreasing=TRUE))

ggplot(data=ei,aes(x=k,y=height))+
  geom_bar(stat="identity",fill="steelblue")+
  theme_minimal()+
  ggtitle("Gain d'inertie inter-classes lors du passage de (k-1) à k classes")+
  xlab("k")+
  ylab("Indice d'aggrégation")+
  scale_x_continuous(breaks=2:dim(data_for_cluster)[1])
```

Dendogramme avec classes
```{r}
plot(as.dendrogram(cah_ward),main="Ward")
rect.hclust(cah_ward,k=5)

cluster_ward_5cl <- data.frame(nom=rownames(data_for_cluster),classe=cutree(cah_ward,k=5))
cluster_ward_5cl[order(cluster_ward_5cl$classe),]
```
```{r}
a = data_for_cluster_grade %>%
  mutate(Cluster = cluster_ward_5cl$classe)

cluster1 = a[a$Cluster == 1,]
cluster2 = a[a$Cluster == 2,]
cluster3 = a[a$Cluster == 3,]
cluster4 = a[a$Cluster == 4,]
cluster5 = a[a$Cluster == 5,]

mytable <- table(cluster5$nutriscore_grade)
options(digits=4)
percentage <- round(100*mytable/sum(mytable),digits = 2)

lbls <- paste(names(mytable), "\n", percentage, "%", sep="")
pie(mytable, labels = lbls,
   main="Nutriscore grade repartition")

```

Analyse
```{r}
clusProfile <- aggregate(data_for_cluster[,2:11],
                         by = list(cluster_ward_5cl$classe),
                         mean)

colnames(clusProfile)[ 1] <- "CLUSTER"
clusLong <- melt(clusProfile, id.vars = "CLUSTER")

ggplot(clusLong) +
  geom_bar(aes(x = variable, y = value, fill = factor(CLUSTER)),
           stat = "identity") +
  scale_fill_grey() +
  facet_wrap(~ CLUSTER) +
  coord_flip() + theme_bw()
```


Kmeans
```{r}
library(FactoMineR)
library(factoextra)
library(cluster)
data_nor <- scale(cleaned_data[,c(3:10,12:14)],center=TRUE,scale=TRUE)
cluster_kmeans_5cl <- kmeans(data_nor,centers=5,nstart=20)
print(cluster_kmeans_5cl)
fviz_cluster(cluster_kmeans_5cl, cleaned_data[,c(3:10,12:14)],palette = c("#009999", "#0000FF", "#FF2400", "#FF6EC7", "#6D071A"))
```

```{r}
# Nettoyage des données:

cleaned_data = data[ (data$vitamin.c_100g<100) & (data$energy.kcal_100g<1000) & (data$proteins_100g<100) & (data$sugars_100g < 80) & (data$fat_100g < 100) & (data$saturated.fat_100g < 100)  & (data$fiber_100g <100) & (data$salt_100g < 100) & (data$sodium_100g <100) & (data$vitamin.a_100g < 100) & (data$calcium_100g < 10), ]
```

```{r}
agnes(data[c(1:10000),c(3:10,12:14)],metric="euclidean",stand=TRUE,method="single")
```

